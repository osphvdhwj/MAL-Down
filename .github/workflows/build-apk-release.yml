name: Build Release APK for Poco X5 Pro

on:
  push:
    branches: [ main, build/* ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - profile

jobs:
  build-apk:
    name: Build APK (Poco X5 Pro Optimized)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true
      
      - name: Verify Environment
        run: |
          echo "Flutter version:"
          flutter --version
          echo ""
          echo "Dart version:"
          dart --version
          echo ""
          echo "Java version:"
          java -version
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Run Code Generation
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            flutter pub run build_runner build --delete-conflicting-outputs || echo "No code generation needed"
          fi
      
      - name: Analyze Code
        run: flutter analyze --fatal-infos
        continue-on-error: true
      
      - name: Run Tests
        run: flutter test --reporter expanded
        continue-on-error: true
      
      - name: Build Release APK (Poco X5 Pro Optimized)
        run: |
          flutter build apk \
            --release \
            --split-per-abi \
            --target-platform android-arm64 \
            --obfuscate \
            --split-debug-info=build/app/outputs/symbols \
            --dart-define=POCO_X5_PRO=true
      
      - name: Rename APK Files
        run: |
          cd build/app/outputs/flutter-apk
          mv app-arm64-v8a-release.apk MAL-Down-v2.0.0-poco-x5-pro-arm64.apk || true
          ls -lh *.apk
      
      - name: Generate APK Info
        run: |
          echo "# ðŸ“¦ Build Information" > apk-info.txt
          echo "" >> apk-info.txt
          echo "**Device Target:** Poco X5 Pro" >> apk-info.txt
          echo "**Android Version:** Android 12+" >> apk-info.txt
          echo "**Architecture:** ARM64-v8a" >> apk-info.txt
          echo "**Build Type:** Release (Obfuscated)" >> apk-info.txt
          echo "**Flutter Version:** 3.32.0" >> apk-info.txt
          echo "**Build Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> apk-info.txt
          echo "" >> apk-info.txt
          echo "## Optimizations:" >> apk-info.txt
          echo "- âœ… ProGuard enabled" >> apk-info.txt
          echo "- âœ… Code obfuscation" >> apk-info.txt
          echo "- âœ… Split per ABI (ARM64 only)" >> apk-info.txt
          echo "- âœ… AMOLED Dark Mode" >> apk-info.txt
          echo "- âœ… 120Hz Display Support" >> apk-info.txt
          echo "- âœ… Material Design 3" >> apk-info.txt
          echo "" >> apk-info.txt
          echo "## APK Files:" >> apk-info.txt
          ls -lh build/app/outputs/flutter-apk/*.apk | awk '{print "- " $9 " (" $5 ")"}' >> apk-info.txt
          cat apk-info.txt
      
      - name: Upload ARM64 APK
        uses: actions/upload-artifact@v4
        with:
          name: MAL-Down-Poco-X5-Pro-ARM64
          path: build/app/outputs/flutter-apk/MAL-Down-v2.0.0-poco-x5-pro-arm64.apk
          retention-days: 90
      
      - name: Upload Debug Symbols
        uses: actions/upload-artifact@v4
        with:
          name: debug-symbols
          path: build/app/outputs/symbols/
          retention-days: 90
      
      - name: Upload APK Info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: apk-info.txt
          retention-days: 30
      
      - name: Build Summary
        run: |
          echo "# ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“± Device: Poco X5 Pro" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APK Files:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh build/app/outputs/flutter-apk/*.apk | awk '{print "- **" $9 "** - " $5}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Optimizations Applied:" >> $GITHUB_STEP_SUMMARY
          echo "- ProGuard R8 code shrinking" >> $GITHUB_STEP_SUMMARY
          echo "- Code obfuscation enabled" >> $GITHUB_STEP_SUMMARY
          echo "- ARM64 architecture only" >> $GITHUB_STEP_SUMMARY
          echo "- AMOLED true black theme" >> $GITHUB_STEP_SUMMARY
          echo "- 120Hz display optimized" >> $GITHUB_STEP_SUMMARY
          echo "- Material Design 3 UI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Artifacts** section above to download your APK." >> $GITHUB_STEP_SUMMARY
